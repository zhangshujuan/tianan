/* ===============================================================================
************   Tabs   ************
=============================================================================== */
+function ($) {
	"use strict";

	var showTab = function (tab, tabLink, force) {
		var newTab = $(tab);
		if (arguments.length === 2) {
			if (typeof tabLink === 'boolean') {
				force = tabLink;
			}
		}
		if (newTab.length === 0) return false;
		if (newTab.hasClass('active')) {
			if (force) newTab.trigger('show');
			return false;
		}
		var tabs = newTab.parent('.tabs');
		if (tabs.length === 0) return false;

		// Animated tabs
		/*var isAnimatedTabs = tabs.parent().hasClass('tabs-animated-wrap');
		  if (isAnimatedTabs) {
		  tabs.transform('translate3d(' + -newTab.index() * 100 + '%,0,0)');
		  }*/

		// Remove active class from old tabs
		var oldTab = tabs.children('.tab.active').removeClass('active');
		// Add active class to new tab
		newTab.addClass('active');
		// Trigger 'show' event on new tab
		newTab.trigger('show');

		// Update navbars in new tab
		/*if (!isAnimatedTabs && newTab.find('.navbar').length > 0) {
		// Find tab's view
		var viewContainer;
		if (newTab.hasClass(app.params.viewClass)) viewContainer = newTab[0];
		else viewContainer = newTab.parents('.' + app.params.viewClass)[0];
		app.sizeNavbars(viewContainer);
		}*/

		// Find related link for new tab
		if (tabLink) tabLink = $(tabLink);
		else {
			// Search by id
			if (typeof tab === 'string') tabLink = $('.tab-link[href="' + tab + '"]');
			else tabLink = $('.tab-link[href="#' + newTab.attr('id') + '"]');
			// Search by data-tab
			if (!tabLink || tabLink && tabLink.length === 0) {
				$('[data-tab]').each(function () {
					if (newTab.is($(this).attr('data-tab'))) tabLink = $(this);
				});
			}
		}
		if (tabLink.length === 0) return;

		// Find related link for old tab
		var oldTabLink;
		if (oldTab && oldTab.length > 0) {
			// Search by id
			var oldTabId = oldTab.attr('id');
			if (oldTabId) oldTabLink = $('.tab-link[href="#' + oldTabId + '"]');
			// Search by data-tab
			if (!oldTabLink || oldTabLink && oldTabLink.length === 0) {
				$('[data-tab]').each(function () {
					if (oldTab.is($(this).attr('data-tab'))) oldTabLink = $(this);
				});
			}
		}

		// Update links' classes
		if (tabLink && tabLink.length > 0) tabLink.addClass('active');
		if (oldTabLink && oldTabLink.length > 0) oldTabLink.removeClass('active');
		tabLink.trigger('active');

		//app.refreshScroller();

		return true;
	};

	var old = $.showTab;
	$.showTab = showTab;

	$.showTab.noConflict = function () {
		$.showTab = old;
		return this;
	};
	//a标签上的click事件，在iscroll下响应有问题
	$(document).on("click", ".tab-link", function(e) {
		e.preventDefault();
		var clicked = $(this);
		showTab(clicked.data("tab") || clicked.attr('href'), clicked);
	});


}(Zepto);

/* ===============================================================================
************   Tabs   ************
=============================================================================== */
+function ($) {
	"use strict";
	$.initFixedTab = function(){
		var $fixedTab = $('.fixed-tab');
		if ($fixedTab.length === 0) return;
		$('.fixed-tab').fixedTab();//默认{offset: 0}
	};
	var FixedTab = function(pageContent, _options) {
		var $pageContent = this.$pageContent = $(pageContent);
		var shadow = $pageContent.clone();
		var fixedTop = $pageContent[0].getBoundingClientRect().top;

		shadow.css('visibility', 'hidden');
		this.options = $.extend({}, this._defaults, {
			fixedTop: fixedTop,
			shadow: shadow,
			offset: 0
		}, _options);

		this._bindEvents();
	};

	FixedTab.prototype = {
		_defaults: {
			offset: 0,
		},
		_bindEvents: function() {
			this.$pageContent.parents('.content').on('scroll', this._scrollHandler.bind(this));
			this.$pageContent.on('active', '.tab-link', this._tabLinkHandler.bind(this));
		},
		_tabLinkHandler: function(ev) {
			var isFixed = $(ev.target).parents('.buttons-fixed').length > 0;
			var fixedTop = this.options.fixedTop;
			var offset = this.options.offset;
			$.refreshScroller();
			if (!isFixed) return;
			this.$pageContent.parents('.content').scrollTop(fixedTop - offset);
		},
		// 滚动核心代码
		_scrollHandler: function(ev) {
			var $scroller = $(ev.target);
			var $pageContent = this.$pageContent;
			var shadow = this.options.shadow;
			var offset = this.options.offset;
			var fixedTop = this.options.fixedTop;
			var scrollTop = $scroller.scrollTop();
			var isFixed = scrollTop >= fixedTop - offset;
			if (isFixed) {
				shadow.insertAfter($pageContent);
				$pageContent.addClass('buttons-fixed').css('top', offset);
			} else {
				shadow.remove();
				$pageContent.removeClass('buttons-fixed').css('top', 0);
			}
		}
	};

	//FixedTab PLUGIN DEFINITION
	// =======================

	function Plugin(option) {
		var args = Array.apply(null, arguments);
		args.shift();
		this.each(function() {
			var $this = $(this);
			var options = $.extend({}, $this.dataset(), typeof option === 'object' && option);
			var data = $this.data('fixedtab');
			if (!data) {
				//获取data-api的
				$this.data('fixedtab', (data = new FixedTab(this, options)));
			}
		});

	}
	$.fn.fixedTab = Plugin;
	$.fn.fixedTab.Constructor = FixedTab;
	$(document).on('pageInit',function(){
		$.initFixedTab();
	});



}(Zepto);
